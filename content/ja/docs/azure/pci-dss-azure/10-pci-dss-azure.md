---
title: "Azure上での PCI DSS 準拠サービスの構築"
date: 2019-07-08T00:00:00+09:00
tags: [Azure,PCIDSS]
description: "求められるサービスのセキュリティとAzure上での PCI DSS Blueprint を元にした準拠サービスの構築"
keywords:
  - "PCIDSS"
  - "Azure"
  - "Blueprint"
eyecatch: "/images/hugo/hugo.png"
draft: true
weight: 10
---

## 概要

ここでは、セキュリティ視点を中心にクラウドアプリケーションの構築をする。PCI DSS 準拠のサービスを、[PCI DSS のための PaaS Web アプリケーション](https://docs.microsoft.com/ja-jp/azure/security/blueprints/pcidss-paaswa-overview) と GitHub 上に公開されているでデプロイ実装の[Azure Security and Compliance Blueprint](https://github.com/Azure/pci-paas-webapp-ase-sqldb-appgateway-keyvault-oms) をベースにおこなった。その時の知見を元に PCI DSSの概要とAzure上での PCI DSS 準拠サービスの構築の情報を共有する。

ここで紹介するアーキテクチャーでは、極力PaaSを使うことにしてる、それに至る背景を理解してもらうため。まずは、クラウドのセキュリティ上の利点と背景の説明し、その後、PCI DSSで要求される高度なセキュリティ基準とAzure上での実装を紹介する。


{{% alert title="TODO" color="info" %}} 
- 済、クラウドでアプリケーションをホスティングすることのセキュリティ上の利点
- 済、他のクラウドサービスモデルに対するサービスとしてのプラットフォーム（PaaS）のセキュリティ上の利点を評価
- 未、セキュリティをネットワーク中心からアイデンティティ中心のセキュリティアプローチに変更
- 未、一般的なPaaSセキュリティベストプラクティスの推奨事項を実装
{{% /alert %}}

## クラウドのセキュリティ上の利点

まず最初に重要なことは、クラウドのセキュリティ上の利点を理解することだ。この利点を活かすことができるかどうかで、プロジェクトの行く末は大きく変わってくる。

オンプレミス環境では、ユーザーが物理層（データセンター、ハードウェア、ネットワーク）、仮想化レイヤーからアプリケーションまですべてのスタックを所有している。攻撃者はすべてのレイヤーの脆弱性を悪用することができ、ユーザーはリソースを全レイヤーのセキュリティ保全に投資する必要がある。ここで重要なのは、セキュリティ投資はビジネスリスクとのバランスで決定される限られたリソースであることだ。

クラウドにアプリケーションをホストすることで、クラウドベースのセキュリティ機能を利用して脅威の検出と対応にかかる時間を短縮することができ、責任をクラウドプロバイダーに移すことで、ユーザーはクラウドプロバイダーと責任を分担することができる。それによって、ユーザは自己の責任範囲にセキュリティリソースを集中、もしくは予算を他のビジネス優先事項に割り当ることが可能となる。

![Cloud security advantages](https://docs.microsoft.com/en-us/azure/security/media/security-paas-deployments/advantages-of-cloud.png)

{{% alert title="TODO" color="info" %}} 
図は書き直すか、どのからの引用なのかを明記するかの、どちらかが必要。書き直すにしても、関連リンクがほしい。MSのドキュメントは更新されてしまうので、書き直さない場合でもローカルにコピーしたほうが良い。以下同様。
{{% /alert %}}

全スタック（レイヤー）を保有するか、必要な一部を保有するかは重要な観点だ。時として、クラウドプロバイダーが提供するものとユーザーの必要要件にはギャップがある。そのギャプを分析しユーザがコントロール可能な、ビジネス要件、アーキテクチャー、実装、運用などのレイヤーでこ対応することができるかどうかを判断する必要がある。

## 共同責任モデル

さらにデプロイモデルと責任分担について復習する。ユーザーとクラウドプロバイダーとの間の責任分担を理解することは非常に重要だ。オンプレミスではスタック全体を所有しているが、クラウドでは、スタックの一部はクラウドプロバイダーによって提供される。そのため、一部の責任がクラウドプロバイダー(Microsoft)に移転する。どのような責任分担となるのかは、下記の responsibility matrix を見てほしい。SaaS、PaaS、およびIaaSの展開おいて、どのスタック領域がユーザー(青)と、Microsoft(灰色)のどちらの担当になるのかを表している。

![responsibility matrix](https://docs.microsoft.com/en-us/azure/security/media/security-paas-deployments/responsibility-zones.png)

この図を下から見ていくと、物理レイヤーは、クラウドプロバイダーの責務となり、その上はクラウドプロバイダーとユーザーの共同責任、さらに上はユーザーの責任となっている。共同責任の部分は、展開モデルによって責任分担の範囲にバリエーションがあり、IaaSではユーザ責任部分が多くなり、SaaSではクラウドプロバイダーの責任部分が多くなる。限られたセキュリティーリソースの有効利用という観点では、SaaS,PaaS、IaaSの順で有効でいうことがわかる。ここでは、サービスを提供するにあたって、サービス要件の充足とユーザーの責任分担を最小化のバランスを考慮しアーキテクチャを構築する。

## PCI DSS 3.2 の概要とAzureでの実装

> PCIデータセキュリティスタンダード（PCI DSS：Payment Card Industry Data Security Standard）は、 クレジットカード情報および取り引き情報を保護するために2004年12月、JCB・American Express・Discover・マスターカード・VISAの国際ペイメントブランド5社が共同で策定した、クレジット業界におけるグローバルセキュリティ基準である。

[Wikipedia: PCIデータセキュリティスタンダード](https://ja.wikipedia.org/wiki/PCI%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%80%E3%83%BC%E3%83%89) より

現在の最新は、PCI DSS 3.2.1。これには、セキュアなサービスを構築する上で必要なことのエッセンスが凝縮している。ここからは、セキュアなサービスと現実的なセキュリティへの取り組みのバランスを学ぶことができる。これは、PCI DSSはクレジットカードブランドが、クレジットカード番号を使った決済の手数料でビジネスをするという国際ペイメントブランドが、自分たちのビジネスモデルを守るために策定した "セキュリティ基準" であることから生まれた結果だ。国際ペイメントブランドとしては、クレジットカードでの取引がが減るほど非現実的（実装コストが高い）なセキュリティを要求すると手数料ビジネスという彼らのビジネスモデルが成立しない。また、クレジットカードの信頼性が失われるほど不正利用が増えた場合もユーザーのカード利用が減ることが予想され不利益となる。この２つの問題を現実的な路線で収束させるのことが、PCI DSS（カウンシル）に期待される役目であり、PCIデータセキュリティスタンダードはその成果物だ。このバランスは社会的な状況によって変動するため、定期的に内容は更新されている。

上記のことを踏まえ、現時点でPCI DSSでなにが求められいるのかと、Azure PCI DSS Blueprint PaaSでの実装を解説する、随時元の規格（PCI DSS)を参照しながら読んで欲しい。

{{% alert title="TODO" color="info" %}} 
- AoCのことを書く [マイクロソフトと PCI DSS](https://www.microsoft.com/ja-jp/TrustCenter/Compliance/PCI)
  > Microsoft Azure では、年 1 回、認定 Qualified Security Assessor (QSA) による PCI DSS 評価を実施しています。監査人が審査するのは Azure 環境です。この審査には、インフラ、開発、運用、管理、サポート、および対象サービスの検証が含まれます。PCI DSS では、取引量に応じて 4 つのレベルのコンプライアンスが指定されています。Azure は PCI DSS Version 3.2 サービス プロバイダー レベル 1 (年間取引量が最も多く、600 万件を超える) 準拠として認定されています。
AoCの読み方解説とか
{{% /alert %}}

## PCI DSS 3.2 序文から

PCI DSSには、12の要件があり、そちらに話が集中することが多いが、要件の前の部分に良いことがいろいろ書いてある。まずは紹介する。

{{% alert title="TODO" color="info" %}} 
***PCI DSSを読み直して内容を確認する***
- PCI DSS 適応性情報（機密情報の定義）P7
- PCI DSS 要件の適応範囲 P10、狭くする
  - 範囲を正確に定義しなるべく狭くせよ
  - ネットワークセグメンテーションの推薦
  - 第三者サービスプロバイダー/アウトソーシング＝AoC
{{% /alert %}}

「ネットワークセグメンテーションは要件ではないが。ネットワークセグメンテーションの利用は、対象範囲の限定、評価コスト、PCI DSSコントロールの実施、維持のコスト及び難易度、組織のリスクを低減する」とあり、これは多くのシステムに適応できる。PCI DSS曰く、多重防衛の１つとしてネットワークセグメンテーションを使うのは難易度、コスト的に優れてるのでお勧めというわけだ。

また、「PCI DSSの適応範囲は、PAN（カード会員番号）を扱っている部分。処理は、伝送、処理、保管を現す」とある。PCI DSSはカード会員番号のセキュリティ基準なのでこうなっているが、Webサイトのセキュリティを考えた場合、守るべく情報を厳密に定義し、「伝送、処理、保管」で、どのように扱うかうべきかを決めることがセキュリティー上有効である。

{{% alert title="TODO" color="info" %}} 
**PCI DSSの対象となるデータ 下書き** 
![account data](/images/pcidss/account-data.png)
{{% /alert %}}

複数の要求レベルの異なったデータの扱いの明確化、ここでは、「カード会員データとセンシティブ認証データの２つに分けて定義」する旨が記述され、カード会員データ（カード番号、有効期限、カード会員名、サービスコード）は、業務上の必要があれば保存可、センシティブ認証データは、処理後破棄、保存不可と明記されている。

それ以外にも、「カード会員データの保存、処理または伝送に関するビジネスニーズおよびプロセスを明確にし、データフロー図を使用してカード会員データフローを文書化しろ」など。

ここで全体的に語られているのは、守るべき情報（守秘情報）を定義し、守秘情報のフロー、処理、ビジネス要件を明らかにすることの必要性です。こう考えると、もしかして必要になるかもしれないので、一緒に渡しておくとか、的な考えは守秘情報には適応できない旨を理解してシステム設計をするべきということが言えます。拡張性、柔軟性とは相反する要件とも言える。

PCI DSSには、代替コントロールという考え方がある、これは一種の回避作でビジネス要件上避けられない場合に用意された方策だ。本稿では、代替コントロールに関しては範囲外として扱わない。

{{% alert title="TODO" color="info" %}} 
このあたりは、全体的なアーキテクチャー上の思想、哲学の部分なので、Azureとはあまり関係ないと思われがちだが、この辺 [Azure Security Documentation](https://docs.microsoft.com/en-us/azure/security/)　見ると出てくる（と思う、詳細は後で）
{{% /alert %}}

## 本システムの構成

Azure PCI DSS Blueprint は、下記のような構成になっている。実際のサイトの構成はさらに複雑だが、ここではBlueprintを元にして構成を説明する。左側のフロントから簡単に説明すると、Applicaiton Gateway + WAFの構成を公開エンドポイントとし、Internal LB経由で、AppService Environmentに接続する。アプリケーションはASEに展開され、バックエンドにはSQL Databaseがある。運用管理用に踏み台サーバー(Bastion)があり、踏み台サーバーへのアクセスはExpress Route経由でアクセス制限された環境とする。ログ、メトリックは、Azure Monitorに集約している。

{{< figure src="/images/pcidss/overview.png" title="Azure PCI DSS アークテクチャー" >}}

本環境を構築するためのリソースは、GitHubで公開されている。スタートとして参考になるだろう。

参考: [Securing PaaS deployments](https://docs.microsoft.com/en-us/azure/security/security-paas-deployments)


## PCI DSS 12 要件

### はじめに

PCI DSS では６カテゴリで１２要件を定めている。ここでは、「安全なネットワークとシステムの構築と維持」、「カード会員データの保護」、「ログ記録と監査」の３つに焦点をあてる。

| | |
| ------------------------------------ |:------------- |
| 安全なネットワークとシステムの構築と維持 | 1. カード会員データを保護するために、ファイアウォールをインストールして構成を維持する |
|  | 2.	システムパスワードおよびその他のセキュリティパラメータにベンダ提供のデフォルト値を使用しない |
| カード会員データの保護 | 3.	保存されるカード会員データを保護する |
|  | 4.	オープンな公共ネットワーク経由でカード会員データを伝送する場合、暗号化する |
| 脆弱性管理プログラムの維持 | 5.	すべてのシステムをマルウェアから保護し、ウイルス対策ソフトウェアまたはプログラムを定期的に更新する |
|  | 6.	安全性の高いシステムとアプリケーションを開発し、保守する |
| 強力なアクセス制御手法の導入 | 7.	カード会員データへのアクセスを、業務上必要な範囲内に制限する | 8.	システムコンポーネントへのアクセスを識別・認証する |
|  | 9.	カード会員データへの物理アクセスを制限する | 
| ネットワークの定期的な監視およびテスト | 10.	ネットワークリソースおよびカード会員データへのすべてのアクセスを追跡および監視する |
| | 11.	セキュリティシステムおよびプロセスを定期的にテストする 
| 情報セキュリティポリシーの維持 | 12. すべての担当者の情報セキュリティに対応するポリシーを維持する |

### 安全なネットワークの構築と維持 - 要件1, 2 

PCI DSS 3.2 では、多重防御の１つとしてネットワーク分離が推薦されていおり、要件1,2として、ネットワーク分離、ネットワーク機材の適切な設定の要件が記述されている。ネットワーク分離は、クラウド上でも有効な方策として広く使われる。多重防御の一つとして使われるという部分と適切な設定運用が重要という部分に注意が必要だ。ここでは、多重防御という観点でどのような方策をとっているのかについて述べる。

**PCI DSS 要件**

- 要件1：カード会員データを保護するために、ファイアウォールをインストールして構成を維持する
- 要件2：システムパスワードおよびその他のセキュリティパラメータにベンダ提供のデフォルト値を使用しない

ここでは、アイソレーションと多重防御という観点で構成を説明する。テクノロジ的には、下記５のものを利用した。

1. ExpressRoute/VNet
2. VNet + Subnet + Network Security Group
3. App Service の Sandbox
4. SQL Database Firewall/Virtual Network Service Endpoints
5. Application Gateway

まず、本システムを全体をAzureに配置する。企業ネットワークとは、ExpressRouteで接続し通信は企業ネットワークの信頼できるシステムと限定された通信のみを行う、特定の業務端末のみに限定する。本システムの運用管理者は、特定の端末からAzure内の踏み台サーバー(Bastin/jumpbox)にログインして運用業務を行う。踏み台サーバーへのアクセスは、オペレータ毎に固有のIDにてログインして行い、監査ログに結果を残す。また、踏み台サーバーで行う業務が最低限になるように管理機能を用意する方針とした。

前記のように、企業ネットワークと本システムをネットワークセグメンテーションした上で、さらにAzure内は仮想ネットワークをサブネットに分割しサブネットへのアクセスをNetwork Security Groupで制限することで本システムのコンポーネント間をネットワークアイソレーションした。分離されたネットワークにコンポーネントを配置し、サブネット間での通信を必要なものみを許可、通信自体を暗号化することで機密データの入出力を保護した。
例えば、"Azure PCI DSS PaaS アークテクチャー" の、Applicaiton Gateway, ASE, Bastion は、それぞれ別々の固有のサブネットにデプロイされ、必要な通信だけをNSGで許可してる。
このように、各サブネットには単一責務のコンポーネントのみを配置することでセキュリティ要件を単純、明確にすることができ、PCI DSS要件で求められるカード会員データ、機密データのデータフローとの一致も担保できる。

３つ目のテクノロジーを使い、インターネット向けのフロント、内部的な管理サイト、バッチ（WebJob）の分離を行った。これらのサブシステムは、App ServiceのSandboxで分離され、お互いの通信は制御された方法だけに制限される。つまり、直接メモリを読んだり、相互にファイルなどのデータのやり取りをすることはできない。

４つ目のテクノロジーは、SQL Database/Azure Storageなどのマネージド・サービスのアクセス制御で利用した。アプリケーションからSQL Databaseのアクセスは、SQL DatabaseのFirewallで特定のVNetからのアクセスのみを許可する設定としている。

また、Webアプリケーションへのアクセスは、Application Gateway（WAF）経由とし既知の脆弱性の問題を軽減する。本システムではWebアプリケーションは、専用サーバーと仮想ネットワークへの配置という観点からApp Service Environment を利用している。

Webアプリケーションの、HTTPS トラフィックは、カスタム ドメインの SSL 証明書を使用し、Azure内の通信はすべて暗号化する。Azure内で通信が傍受される可能性が低いが、ハード、ソフトともに暗号化のコストも低く導入障壁も低いことから全通信の暗号化を導入した。

PCI DSS要件では、ネットワーク機器のパスワードに初期値が使われていない等の適切な設定がされていること、変更を管理することを求めている。Azureでは、共通のデフォルトパスワードは存在しない、リソースの変更権限はRBACでコントールでき、設定はAPIで取得できる。また、変更はActivity Logにロギングされる。これらの機能によって、従来環境より低い難易度で要件を充足することができた。

Log Analytics が、広範にわたる変更のログ記録を提供することで、変更内容の確認、検証を可能とし設定の正確性を確保する。

{{% alert title="TODO" color="info" %}} 
Blueprintを元に、追加のドキュメントとして、[Azure network security](https://docs.microsoft.com/en-us/azure/security/abstract-azure-network-security) を絡めて書く。

このあたりは、追加で別途書いたほうが良いかも。
{{% /alert %}}

#### Application Gatewayの機能

インターネットフロントからの攻撃を防御するために、AzureのWAF ([OWASP 3.0ルールセット](https://docs.microsoft.com/ja-jp/azure/application-gateway/overview#web-application-firewall))に対応した [Application Gateway](https://docs.microsoft.com/ja-jp/azure/application-gateway/overview) を使用することで、セキュリティの脆弱性のリスクを軽減した。Application Gateway は、カード会員WEB用（インターネットアクセス可）と担当者画面用（ExpressRoute経由のみ）の２つがある。ぞれぞれのApplication Gatewayは、固有のApp Servicesのフロントに設定した。
本システムでは、Application Gatewayの下記の機能を利用した。

1. エンド ツー エンド SSL
2. SSL オフロードの有効化
3. TLS v1.0 および v1.1 の無効化
4. Web アプリケーション ファイアウォール (WAF モード)
5. OWASP 3.0 ルールセットを使用した検出モード
6. 診断ログの有効化
7. カスタム正常性プローブ
8. Azure Security Center と Azure Advisor による、保護と通知の提供。 

**関連PCI DSS要件** 要件 1.3, 要件 1.3.1, 要件 1.3.2, 要件 2.2.3, 要件 4.1, 要件 6.1, 要件 6.6, 要件 付録A2

#### Network Security Groupの役割

サブネット毎にコンポーネントを分割配置し、各サブネットに専用のNetwork Security Group (NSG) を定義。通信を制限した。例えば、本システムでは下記の種類のNSGを定義している。

1.	ファイアウォールおよび Application Gateway WAF 用の DMZ ネットワーク セキュリティ グループ
2.	ジャンプボックス (要塞ホスト) 管理用の NSG
3.	App Service Environment 用の NSG
4.	Azure Batch用のNSG

各 NSG には、本システムの安全かつ適切な操作のために開かれる固有のポートとプロトコルを設定し、Log Analyticsにログを保存する。

サブネットとNSGによるネットワーク分離は Azure上では、リソース的には無料のセキュリティーである。通常は、NSGルールの保全などの運用コストの面から簡易化さえることが多いが、本ステムのように高いセキュリティーが要求されるものでは活用するこが有用だ。今回も、リソースの仮想ネットワークへの配置とNSGによる分離を利用してる。

**関連PCI DSS要件** 要件 1.2, 要件 1.2.1, 要件 6.3.1, 要件 6.3.2, 要件 6.4.1, 要件 6.4.2

### カード会員データの保護 - 要件 3,4 

要件3,4は、カード会員データをどのように保護するかを扱っている。暗号化、切り捨て、マスキング、ハッシュなどの保護方式が記述されている。これは、侵入者が他のセキュリティコントロールを回避し、カード会員データにアクセスできても、正しい暗号化鍵がなければ、そのデータを読み取り、使用することはできないようにすることを目的としています。もともと、カード会員データは絶対的に必要でない限り保存しない、完全な カード番号が不要なら切り捨てるなどの方法を勧めている。

- 要件3：保存されたカード会員データを保護する
- 要件4：オープンな公共ネットワーク経由でカード会員データを伝送する場合、暗号化する

Azureでは、暗号化全般の導入コストが低く、DBの暗号化は標準的な機能として提供されている。

データの保存先としては、下記の２つを利用するが、ここではSQL Databaseについて説明する。

1. Azure Storage
2. Azure SQL Database

####	Azure SQL Database

Azure SQL Database インスタンスは、次のデータベース セキュリティ対策を使用する。管理者はSQL Databaseに、限られた権限を与えらたADユーザーとしてアクセスする。アプリケーションはKeyVautに保存された資格情報を使ってアクセスし、管理者のアクセスとは区別できるようにする。

1. AD の認証と承認
2. SQL Database 監査
3. Azure SQL Databaseのファイアウォール規則
4. Azure SQL Database の脅威の検出
5. 認証情報のKey Vaultへの保存

システムではメディアを用いたバックアップ、複製や移動を行わない。

**関連PCI DSS要件** 要件 1.3.4, 要件 1.3.6, 要件 3.3, 要件 3.4, 要件 4.1, 要件 9.5, 要件 9.5.1, 要件 9.6, 要件 9.6.1, 要件 9.6.2, 要件9.6.3, 要件 9.7, 要件 9.8

### 要件7,8,9 強固なアクセス制御手法の導入

- 要件7：カード会員データへのアクセスを、業務上必要な範囲内に制限する
- 要件8：コンピュータにアクセスできる各ユーザに一意の ID を割り当てる
- 要件9：カード会員データへの物理アクセスを制限する

Azureにおける分離の話を書くと長くなる。[Isolation in the Azure Public Cloud](https://docs.microsoft.com/en-us/azure/security/azure-isolation)

ここでは、特定のカード会員番号だけにアクセスできる人（エンドユーザー）と不特定多数のカード会員番号にアクセスできる人を分けて扱っていることが重要。脅威は内部にもある。

### 要件10,11 ネットワークの定期的な監視およびテスト

- 要件10：ネットワークリソースおよびカード会員データへのすべてのアクセスを追跡および監視する
- 要件11：セキュリティシステムおよびプロセスを定期的にテストする

モニターと監査、[Azure security management and monitoring overview](https://docs.microsoft.com/en-us/azure/security/security-management-and-monitoring-overview) このあたりが、良いけど。構成的にもっと前にもっていったほうが良いかも。

ここには、Shared responsibility（共同責任モデル）、Role-Based Access Control、Antimalware、Multi-Factor Authentication、ExpressRoute、Virtual network gateways とかの話が書いてある。いろいろ新しいのが出すぎてるので、どうするか検討する。

この部分は、アクセス権を適切に設定し、ログを取る（監査）の二本立ての片方（２つめ）

#### ログ記録と監査
アプリケーションログは、最初にApplication Insightに配送され、その後Log Analytics に送られる。Log Analyticsは 本システム のすべてのシステムおよびユーザー アクティビティの広範なログ記録 (カード所有者データのログ記録を含む) を提供する。 また、Azure リソースの正確性を確保するために、変更内容を確認および検証できる。 

- アクティビティ ログ
  アクティビティ ログは、サブスクリプションのリソースに対して実行された操作を記録する
- 診断ログ
  診断ログは、リソースによって出力されるすべてのログです。 これらのログには、Windows イベント システム ログ、Azure Blob Storage、テーブル、キューのログが含まれる。
- ファイアウォール ログ
  Application Gateway は、完全な診断およびアクセス ログを提供する。OWASPルールのログが出力される。
- ログのアーカイブ
すべてのログは Azure Log Analytics に接続されて処理、格納、ダッシュボード化される。Log Analyticsは、クラウドおよびオンプレミス環境内のリソースで生成されたデータの収集と分析のマネージド・サービスである。

***関連PCI DSS要件*** 要件 1.1.1, 要件 2.2, 要件 2.4, 要件 6.4, 要件 9.9, 要件 10.1, 要件 10.2, 要件 10.7, 要件 10.8, 要件 11.5, 要件 11.5.1, 要件 11.6

#### Application Insights
アプリケーションのパフォーマンス管理と瞬時の分析のため、Application Insightsが設定されています。本ログは、保存を目的としたものでは無く保存期間は90日です。保存のためには、本システムでは下記テレメトリをLog Analytics に転送しています。Traceテレメトリは転送されないのに注意してください。

- 可用性
- 例外
- Requests
- ページ ビュー（未使用）
- カスタム イベント

担当者画面の操作履歴は、Application Insightのカスタムイベントとして出力されます。操作履歴は、Log Analyticsに転送され規定の期間保存されます。
また、Application Insights では、"サンプリング補正" によって、テレメトリのトラフィックを削減します。本システムでは、カスタム イベントをサンプリング対象外としています。
5.2.	Log Analytics
Log Analyticsは Azure のサービスであり、クラウドおよびオンプレミスの環境内にあるリソースで生成されたデータを収集します。
リテンションは、365日で、ログは365日間保持される。データ量に制限は無いが、容量で利用料金が変わる。Log Analytics データのセキュリティについては、下記リンクを参照のこと。
https://docs.microsoft.com/ja-jp/azure/log-analytics/log-analytics-data-security
x